<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_images_procedure.xml" version="5.0" xml:id="cha-images-procedure">
 <title>部署 raw 映像</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  <phrase role="productname"><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase> 提供可直接部署到设备储存（内存卡、USB 闪存盘或硬盘）的 raw 映像。映像可部署到的设备类型选项取决于您的特定硬件 — 请遵照供应商文档选择。
 </para>
 <para>
  要对部署的映像进行初始配置，您需要按<xref linkend="pro-preparing-configuration-device"/>中所述准备配置数据，并且需要将配置数据复制到某个设备（例如 USB 磁盘）上。设备需要在首次引导时连接到运行 SLE Micro 的主机。
 </para>
 <para>
  要准备设置，您需要两个单独的设备。一个用于存放运行 SLE Micro 的 raw 磁盘映像，另一个充当配置媒体。
 </para>
 <procedure xml:id="proc-prepare-image">
  <title>准备 raw 磁盘映像</title>
  <step>
   <para>
    下载 raw 映像并将其解压缩：
   </para>
<screen><prompt>tux &gt; </prompt>xz -d <replaceable>DOWNLOADED_IMAGE.raw.xz</replaceable></screen>
  </step>
  <step>
   <para>
    将解压缩后的映像复制到将运行 SLE Micro 的设备：
   </para>
<screen><prompt>tux &gt; </prompt>dd if=<replaceable>DOWNLOADED_IMAGE.raw</replaceable> of=/dev/sd<replaceable>X</replaceable></screen>
  </step>
 </procedure>
 <para>
  下面的过程说明如何准备配置设备（通常是 USB 闪存盘）。
 </para>
 <procedure xml:id="pro-preparing-configuration-device">
  <title>准备配置设备</title>
  <step>
   <para>
    将磁盘格式化为 SLE Micro 支持的任何文件系统：Ext3、Ext4 等。属性：
   </para>
<screen>
<prompt>tux &gt; </prompt>sudo mkfs.ext4 /dev/sd<replaceable>Y</replaceable>
</screen>
  </step>
  <step>
   <para>
    将设备标签设置为 <literal>ignition</literal>（使用 Ignition 或 Combustion 时）或 <literal>combustion</literal>（仅使用 Combustion 时）。对于 Ext4 文件系统：
   </para>
<screen><prompt>tux &gt; </prompt>sudo e2label /dev/sd<replaceable>Y</replaceable> ignition</screen>
   <para>
    您可以使用您的虚拟化系统或硬件支持的任何类型的配置储存媒体 — ISO 映像、USB 闪存盘等。
   </para>
  </step>
  <step>
   <para>
    挂载设备：
   </para>
<screen>
<prompt>tux &gt; </prompt>sudo mount /dev/sdY /mnt
</screen>
  </step>
  <step>
   <para>
    创建<xref linkend="cha-images-ignition"/>或<xref linkend="cha-images-combustion"/>中所述的目录结构，具体取决于使用的配置工具：
   </para>
<screen>
<prompt>tux &gt; </prompt>sudo mkdir -p /mnt/ignition/
</screen>
   <para>
    或：
   </para>
<screen>
<prompt>tux &gt; </prompt>sudo mkdir -p /mnt/combustion/
</screen>
  </step>
  <step>
   <para>
    在首次引导前，准备 <xref linkend="cha-images-ignition" xrefstyle="template:Ignition"/> 或 <xref linkend="cha-images-combustion" xrefstyle="template:Combustion"/> 将要使用的配置的所有元素。要登录系统，您需要提供 <systemitem class="username">root</systemitem> 的口令或设置无口令身份验证，否则首次引导后将无法访问系统。
   </para>
  </step>
 </procedure>
 <para>
  首次引导之后，您需要使用命令行工具 <command>SUSEConnect</command> 注册 SUSE Linux Enterprise Micro 实例。有关细节，请参见<xref linkend="sec-images-registration"/>。
 </para>
 <para>
  SLE Micro 提供了可用于在线增补的扩展。要使用此扩展，您需要从已安装系统将扩展添加到您的订阅中。有关细节，请参见<xref linkend="sec-adding-extension"/>。
 </para>
 <sect1 xml:id="sec-images-registration">
  <title>注册</title>

  <para>
   可以使用 <command>SUSEConnect</command> 从命令行注册系统。如果所需的信息超出了本节的范畴，请使用 <command>SUSEConnect
   --help</command> 查看内联文档。
  </para>

  <procedure>
   <title>使用 SUSEConnect 注册产品</title>
   <step>
    <para>
     要在 SUSE Customer Center 中注册 <phrase role="productname"><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase>，请按如下所示运行 <command>SUSEConnect</command>：
    </para>
<screen><prompt role="root">root # </prompt>SUSEConnect -r <replaceable>REGISTRATION_CODE</replaceable> -e <replaceable>EMAIL_ADDRESS</replaceable></screen>
    <para>
     要在本地注册服务器中注册，另请提供该服务器的 URL：
    </para>
<screen><prompt role="root">root # </prompt>SUSEConnect -r <replaceable>REGISTRATION_CODE</replaceable> -e <replaceable>EMAIL_ADDRESS</replaceable> \
--url "https://suse_register.example.com/"</screen>
    <para>
     将 <replaceable>REGISTRATION_CODE</replaceable> 替换为与 <phrase role="productname"><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase> 副本一同收到的注册码。将 <replaceable>EMAIL_ADDRESS</replaceable> 替换为与您或您的组织管理订阅时所用的 SUSE 帐户关联的电子邮件地址。
    </para>
   </step>
   <step>
    <para>
     <phrase role="productname"><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase> 现已注册完毕。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-adding-extension">
  <title>管理扩展</title>

  <para>
   SLE Micro 支持内核在线增补扩展。请注意，您可能需要额外订阅该扩展。
  </para>

  <note>
   <title><literal>SUSE Linux Enterprise Live Patching</literal> 可用性</title>
   <para>
    <literal>SUSE Linux Enterprise Live Patching</literal> 扩展仅适用于 x86（实时内核除外）和 IBM Z 体系结构。
   </para>
  </note>

  <para>
   由于该扩展的激活或停用以事务更新方式进行，因而会创建新的快照，您需要重启动系统才能引导到新的快照并应用更改。
  </para>

  <sect2 xml:id="sec-slemicro-live-patching">
   <title>激活 <literal>SUSE Linux Enterprise Live Patching</literal></title>
   <para>
    如果您需要激活在线增补扩展，请运行以下命令列出可用扩展：
   </para>
<screen><prompt role="root">root # </prompt>transactional-update --quiet register -list-extensions</screen>
   <para>
    输出中会提供如何激活在线增补扩展的命令：
   </para>
<screen>
<prompt role="root">root # </prompt>transactional-update register -p sle-module-live-patching/15.3/x86_64 \
  -r <replaceable>registration code</replaceable>
</screen>
   <para>
    激活 <literal>SUSE Linux Enterprise Live Patching</literal> 扩展后，在 <filename>/etc/zypp/zypp.conf</filename> 文件中按如下方式配置 <literal>libzypp</literal>：
   </para>
   <variablelist>
    <varlistentry>
     <term><literal>multiversion = provides:multiversion(kernel)</literal></term>
     <listitem>
      <para>
       这会在增补系统的同时，确保当前内核保持运行状态，否则，在应用内核更新时可能会发生依赖项冲突
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>multiversion.kernels = latest</literal></term>
     <listitem>
      <para>
       这会在应用在线补丁后在新快照中执行内核清理。如果未设置此命令，快照将保留之前的内核，并且也会在之前的内核上执行内核更新。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    另外，请在 <filename>/etc/sysconfig/livepatching</filename> 文件中设置 <literal>LIVEPATCH_KERNEL='always'</literal>。
   </para>
   <note>
    <title>与内核匹配的 <literal>kernel-default-livepatch</literal> 版本</title>
    <para>
     为了确保内核升级后仍会安装在线补丁，请安装匹配版本的 <literal>kernel-default-livepatch</literal> 软件包。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-disable-live-patching">
   <title>停用 <literal>SUSE Linux Enterprise Live Patching</literal></title>
   <para>
    要停用该扩展，请运行以下命令：
   </para>
<screen>
<prompt role="root">root # </prompt>transactional-update register -d \
  -p sle-module-live-patching/15.3/x86_64
</screen>
  </sect2>
 </sect1>
</chapter>
